<template>
  <div class="container mx-auto px-4 pt-8">
    <div class="flex">
      <div class="flex-initial">
        <svg
          width="238"
          height="35"
          viewBox="0 0 238 35"
          fill="none"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            d="M52.7728 17.9094C52.7842 15.6594 54.1592 14.3412 56.1364 14.3412C58.1023 14.3412 59.2614 15.6025 59.2501 17.7503V28.0003H64.091V16.8866C64.1023 12.7957 61.6932 10.3184 58.0569 10.3184C55.4092 10.3184 53.6364 11.5684 52.841 13.6253H52.6364V4.72754H47.9319V28.0003H52.7728V17.9094Z"
            fill="black"
          />
          <path
            d="M75.787 28.3412C81.0825 28.3412 84.3779 24.7162 84.3779 19.3412C84.3779 13.9321 81.0825 10.3184 75.787 10.3184C70.4915 10.3184 67.1961 13.9321 67.1961 19.3412C67.1961 24.7162 70.4915 28.3412 75.787 28.3412ZM75.8097 24.5912C73.3665 24.5912 72.1165 22.3525 72.1165 19.3071C72.1165 16.2616 73.3665 14.0116 75.8097 14.0116C78.2075 14.0116 79.4575 16.2616 79.4575 19.3071C79.4575 22.3525 78.2075 24.5912 75.8097 24.5912Z"
            fill="black"
          />
          <path
            d="M95.412 28.3412C100.06 28.3412 102.98 25.6139 103.207 21.6025H98.6393C98.3552 23.4662 97.1279 24.5116 95.4688 24.5116C93.2075 24.5116 91.7415 22.6139 91.7415 19.273C91.7415 15.9775 93.2188 14.0912 95.4688 14.0912C97.2415 14.0912 98.3779 15.2616 98.6393 17.0003H103.207C103.003 12.9662 99.9461 10.3184 95.3893 10.3184C90.0938 10.3184 86.8211 13.9889 86.8211 19.3412C86.8211 24.648 90.037 28.3412 95.412 28.3412Z"
            fill="black"
          />
          <path
            d="M117.5 20.5684C117.511 22.9094 115.909 24.1366 114.171 24.1366C112.341 24.1366 111.159 22.8525 111.148 20.7957V10.5457H106.307V21.6594C106.318 25.7389 108.705 28.2275 112.216 28.2275C114.841 28.2275 116.727 26.8753 117.511 24.8298H117.693V28.0003H122.341V10.5457H117.5V20.5684Z"
            fill="black"
          />
          <path
            d="M140.736 15.523C140.304 12.3071 137.713 10.3184 133.304 10.3184C128.838 10.3184 125.895 12.3866 125.906 15.7503C125.895 18.3639 127.543 20.0571 130.952 20.7389L133.975 21.3412C135.497 21.648 136.19 22.2048 136.213 23.0798C136.19 24.1139 135.065 24.8525 133.372 24.8525C131.645 24.8525 130.497 24.1139 130.202 22.6934L125.44 22.9434C125.895 26.2844 128.736 28.3412 133.361 28.3412C137.884 28.3412 141.122 26.0344 141.134 22.5912C141.122 20.0684 139.474 18.5571 136.088 17.8639L132.929 17.2275C131.304 16.8753 130.702 16.3184 130.713 15.4775C130.702 14.4321 131.884 13.7503 133.384 13.7503C135.065 13.7503 136.065 14.6707 136.304 15.7957L140.736 15.523Z"
            fill="black"
          />
          <path
            d="M144.182 34.5457H149.023V25.2048H149.171C149.841 26.6594 151.307 28.2844 154.125 28.2844C158.102 28.2844 161.205 25.1366 161.205 19.2957C161.205 13.2957 157.966 10.3184 154.136 10.3184C151.216 10.3184 149.818 12.0571 149.171 13.4775H148.955V10.5457H144.182V34.5457ZM148.921 19.273C148.921 16.1594 150.239 14.1707 152.591 14.1707C154.989 14.1707 156.261 16.2503 156.261 19.273C156.261 22.3184 154.966 24.4321 152.591 24.4321C150.261 24.4321 148.921 22.3866 148.921 19.273Z"
            fill="black"
          />
          <path
            d="M172.318 28.3412C177.614 28.3412 180.909 24.7162 180.909 19.3412C180.909 13.9321 177.614 10.3184 172.318 10.3184C167.023 10.3184 163.727 13.9321 163.727 19.3412C163.727 24.7162 167.023 28.3412 172.318 28.3412ZM172.341 24.5912C169.898 24.5912 168.648 22.3525 168.648 19.3071C168.648 16.2616 169.898 14.0116 172.341 14.0116C174.739 14.0116 175.989 16.2616 175.989 19.3071C175.989 22.3525 174.739 24.5912 172.341 24.5912Z"
            fill="black"
          />
          <path
            d="M191.943 28.3412C196.591 28.3412 199.511 25.6139 199.739 21.6025H195.171C194.886 23.4662 193.659 24.5116 192 24.5116C189.739 24.5116 188.273 22.6139 188.273 19.273C188.273 15.9775 189.75 14.0912 192 14.0912C193.773 14.0912 194.909 15.2616 195.171 17.0003H199.739C199.534 12.9662 196.477 10.3184 191.921 10.3184C186.625 10.3184 183.352 13.9889 183.352 19.3412C183.352 24.648 186.568 28.3412 191.943 28.3412Z"
            fill="black"
          />
          <path
            d="M214.031 20.5684C214.043 22.9094 212.44 24.1366 210.702 24.1366C208.872 24.1366 207.69 22.8525 207.679 20.7957V10.5457H202.838V21.6594C202.849 25.7389 205.236 28.2275 208.747 28.2275C211.372 28.2275 213.259 26.8753 214.043 24.8298H214.224V28.0003H218.872V10.5457H214.031V20.5684Z"
            fill="black"
          />
          <path
            d="M237.267 15.523C236.835 12.3071 234.244 10.3184 229.835 10.3184C225.369 10.3184 222.426 12.3866 222.438 15.7503C222.426 18.3639 224.074 20.0571 227.483 20.7389L230.506 21.3412C232.028 21.648 232.722 22.2048 232.744 23.0798C232.722 24.1139 231.597 24.8525 229.903 24.8525C228.176 24.8525 227.028 24.1139 226.733 22.6934L221.972 22.9434C222.426 26.2844 225.267 28.3412 229.892 28.3412C234.415 28.3412 237.653 26.0344 237.665 22.5912C237.653 20.0684 236.006 18.5571 232.619 17.8639L229.46 17.2275C227.835 16.8753 227.233 16.3184 227.244 15.4775C227.233 14.4321 228.415 13.7503 229.915 13.7503C231.597 13.7503 232.597 14.6707 232.835 15.7957L237.267 15.523Z"
            fill="black"
          />
          <path
            d="M16.5 33.5C16.6556 33.5042 17.6703 33.6209 19.0001 33.5C24 33.0455 28.5 31 32.5 24.5C29.5 29 23.9031 32.3458 18.1299 32.1195C9.47649 31.7803 2.35972 24.4914 2.72693 15.9685C3.06753 8.0633 9.95216 1.5178 18.046 1.88036C25.5148 2.21493 31.6385 8.52788 31.2732 15.8758C30.9381 22.6148 25.0435 28.1824 18.1429 27.8218C11.8575 27.4933 6.72699 22.1556 7.08957 15.9841C7.41708 10.4098 12.3228 5.81993 18.0282 6.17773C23.1324 6.49783 27.2695 10.8615 26.911 15.8539C26.5942 20.2666 22.6757 23.8785 18.1689 23.5252C14.2419 23.2173 11.0989 19.8259 11.4505 16.0174C11.7512 12.7607 14.6854 10.1275 17.9868 10.4726C20.745 10.7609 22.8912 13.1832 22.5533 15.7973C22.28 17.9116 20.3246 19.5618 18.2456 19.2359C16.6317 18.9828 15.4968 17.5238 15.7958 16.1361C15.8948 15.6763 16.189 15.2341 16.5807 14.9563C16.9598 14.6875 17.3808 14.6017 17.7916 14.7305C17.902 14.7651 18.0211 14.8359 18.1231 14.926C18.1166 14.9258 18.1102 14.9256 18.1037 14.9256C18.0994 14.9255 18.0951 14.9255 18.0907 14.9255C17.5385 14.9255 17.0907 15.3732 17.0907 15.9255C17.0907 16.3304 17.2461 16.7988 17.6926 17.085C18.0746 17.3298 18.4815 17.314 18.7224 17.2741C18.9851 17.2305 19.2297 17.1308 19.429 17.0142C19.6151 16.9053 19.8534 16.7283 20.0215 16.4683C20.5582 15.6377 20.4001 14.747 20.0208 14.1129C19.6581 13.5063 19.0469 13.0281 18.3899 12.8221C17.2889 12.4769 16.2265 12.7557 15.4238 13.3249C14.6337 13.8852 14.0475 14.7546 13.8406 15.7149C13.2417 18.4951 15.4783 20.8264 17.9359 21.2117C21.2836 21.7366 24.1404 19.1204 24.5368 16.0537C25.0416 12.1479 21.8842 8.86905 18.1947 8.48342C13.6872 8.01229 9.85276 11.5683 9.45897 15.8335C8.9922 20.8893 13.1154 25.1352 18.0126 25.5191C23.6936 25.9644 28.5145 21.4475 28.9059 15.9971C29.3522 9.78246 24.25 4.56399 18.1533 4.18165C11.293 3.75142 5.48255 9.2368 5.09302 15.8668C4.65956 23.2445 10.7462 29.438 18.0385 29.8191C26.0811 30.2394 32.8826 23.782 33.2707 15.9752C33.4325 12.7199 32.5056 9.66399 30.8266 7.10719C27.7421 2.80383 22.6985 0 17 0C15.6239 0 14.2861 0.16349 13.0047 0.472105C6.18082 2.39028 1.04121 8.63103 0.728781 15.8824C0.332541 25.0791 7.51328 32.3795 16.5 33.5Z"
            fill="black"
          />
        </svg>
      </div>
      <div class="flex-initial flex justify-center items-center ml-3">
        <span class="py-1 px-1 border-2 border-black rounded-md uppercase font-bold text-xs p-0 leading-none tracking-wider">monitor</span>
      </div>
    </div>

    <div class="grid gap-4 grid-cols-1 lg:grid-cols-3 mt-16">
      <div class="mb-2">
        <info :info="info" />
      </div>
      <div class="mb-2">
        <cpu :data="cpu" />
      </div>
      <div class="mb-2">
        <memory :data="memory" />
      </div>
    </div>

    <div class="mt-8">
      <connections
        :connection-count="connectionCount"
        :document-count="documentCount"
        :message-count="messageCount"
      />
    </div>

    <div class="mt-24">
      <documents :documents="documents" />
    </div>

    <div class="mt-8 z-10 relative">
      <log
        :connections="connectionLog"
        :documents="documentLog"
      />
    </div>
  </div>
</template>

<script>
import Vue from 'vue'
import Connections from './Connections'
import Cpu from './Cpu'
import Documents from './Documents'
import Info from './Info'
import Log from './Log'
import Memory from './Memory'

export default Vue.extend({
  components: {
    Connections,
    Cpu,
    Documents,
    Info,
    Log,
    Memory,
  },

  data() {
    return {
      connectionCount: [],
      connectionLog: [],
      cpu: [],
      documentCount: [],
      documentLog: [],
      documents: {},
      info: {},
      memory: [],
      messageCount: [],
      socket: null,
    }
  },

  methods: {
    handleMessage(input) {
      const {
        data,
        event,
      } = JSON.parse(input.data)

      if (event === 'add') {
        data.forEach(({
          timestamp,
          key,
          value,
        }) => {
          if (!this[key]) {
            return
          }

          if (!Array.isArray(this[key])) {
            this[key] = value
            return
          }

          if (!Array.isArray(value)) {
            this[key].push({
              key,
              timestamp,
              value,
            })
            return
          }

          this[key] = this[key].concat(value.map(value => ({
            key,
            timestamp,
            value,
          })))
        })
      }

      if (event === 'set') {
        if (!this[data.key]) {
          return
        }

        this[data.key] = {
          ...this[data.key],
          ...data.value,
        }
      }
    },
  },

  mounted() {
    this.socket = new WebSocket(
      window.location.href
        .replace('http:', 'ws:')
        .replace('https:', 'wss:'),
    )

    this.socket.onmessage = this.handleMessage.bind(this)
  },
})
</script>
